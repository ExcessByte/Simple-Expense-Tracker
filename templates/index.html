<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Expense Tracker</title>
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Expy.</h1>
            <div style="display: flex; gap: 10px;">
                <button class="add-button" id="openFilterModalBtn">Filter</button>
                <button class="add-button" id="openModalBtn">Add Transaction</button>
            </div>
        </div>

        <div class="summary">
            <div class="summary-item">
                <h3>Income</h3>
                <p class="summary-income" id="totalIncome">{{ summary.income }} Rs</p>
            </div>
            <div class="summary-item">
                <h3>Expenses</h3>
                <p class="summary-expense" id="totalExpenses">{{ summary.expenses }} Rs</p>
            </div>
            <div class="summary-item">
                <h3>Net Balance</h3>
                <p class="summary-balance" id="netBalance">{{ summary.balance }} Rs</p>
            </div>
        </div>

        <h2>All Transactions</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="transactions-table-body">
            </tbody>
        </table>

    </div>

    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalTitle">Add a New Transaction</h2>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-group">
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div class="form-group">
                    <label for="description">What did you spend on?</label>
                    <input type="text" id="description" name="description" required>
                </div>
                <div class="form-group">
                    <label for="category">Category:</label>
                    <select id="category" name="category" required>
                        <option value="Food">Food</option>
                        <option value="Transport">Transport</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Work">Work</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="type">Is this income or expense?</label>
                    <select id="type" name="type" required>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount">Amount:</label>
                    <input type="number" id="amount" name="amount" step="0.01" required>
                </div>
                <button type="submit" id="submitBtn">Save</button>
            </form>
        </div>
    </div>

    <div id="filterModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Filter Transactions</h2>
            <form id="filterForm">
                <div class="form-group">
                    <label for="filterCategory">Category:</label>
                    <select id="filterCategory" name="category">
                        <option value="all">All</option>
                        <option value="Food">Food</option>
                        <option value="Transport">Transport</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Work">Work</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterType">Type:</label>
                    <select id="filterType" name="type">
                        <option value="all">All</option>
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterYear">Year:</label>
                    <select id="filterYear" name="year">
                        <option value="all">All</option>
                        {% for year in range(2020, 2030) %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterMonth">Month:</label>
                    <select id="filterMonth" name="month">
                        <option value="all">All</option>
                        {% for month_name in months %}
                            <option value="{{ loop.index }}">{{ month_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" id="applyFiltersBtn">Apply Filters</button>
            </form>
        </div>
    </div>
    
    <script>
        const transactionsTable = document.getElementById('transactions-table-body');
        const addModal = document.getElementById('transactionModal');
        const filterModal = document.getElementById('filterModal');
        const addBtn = document.getElementById('openModalBtn');
        const filterBtn = document.getElementById('openFilterModalBtn');
        const closeBtns = document.querySelectorAll('.close-button');
        const addForm = document.getElementById('transactionForm');
        const filterForm = document.getElementById('filterForm');
        const titleText = document.getElementById('modalTitle');
        const submitBtnText = document.getElementById('submitBtn');
        const hiddenId = document.getElementById('transactionId');

        const allTransactions = JSON.parse('{{ transactions | tojson | safe }}');

        showTransactions(allTransactions);

        function showTransactions(transactionsToShow) {
            transactionsTable.innerHTML = '';
            transactionsToShow.forEach(function(item) {
                const row = document.createElement('tr');
                let amountColor = item.type === 'expense' ? 'expense-amount' : 'income-amount';
                
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.description}</td>
                    <td>${item.category}</td>
                    <td class="${amountColor}">${item.amount} Rs</td>
                    <td>
                        <button class="edit-button" data-id="${item.id}">Edit</button>
                        <button class="delete-button" data-id="${item.id}">Delete</button>
                    </td>
                `;
                transactionsTable.appendChild(row);
            });
        }
        
        addBtn.onclick = function() {
            addForm.reset();
            titleText.textContent = 'Add a New Transaction';
            submitBtnText.textContent = 'Save';
            addModal.style.display = 'block';
        };

        filterBtn.onclick = function() {
            const urlInfo = new URLSearchParams(window.location.search);
            document.getElementById('filterCategory').value = urlInfo.get('category') || 'all';
            document.getElementById('filterType').value = urlInfo.get('type') || 'all';
            document.getElementById('filterYear').value = urlInfo.get('year') || 'all';
            document.getElementById('filterMonth').value = urlInfo.get('month') || 'all';
            filterModal.style.display = 'block';
        };

        closeBtns.forEach(function(btn) {
            btn.onclick = function() {
                addModal.style.display = 'none';
                filterModal.style.display = 'none';
            };
        });

        window.onclick = function(event) {
            if (event.target == addModal) {
                addModal.style.display = 'none';
            }
            if (event.target == filterModal) {
                filterModal.style.display = 'none';
            }
        };

        addForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const transactionData = {
                date: addForm.date.value,
                description: addForm.description.value,
                category: addForm.category.value,
                type: addForm.type.value,
                amount: parseFloat(addForm.amount.value)
            };
            
            const transId = hiddenId.value;
            let url = '/api/transactions';
            let method = 'POST';

            if (transId) {
                url = `/api/transactions/${transId}`;
                method = 'PUT';
            }

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(transactionData)
            })
            .then(function(response) {
                if (response.ok) {
                    window.location.reload(); 
                } else {
                    alert('Oops! Something went wrong saving the transaction.');
                }
            });
        });

        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const newUrl = new URL(window.location.href.split('?')[0]);
            const formData = new FormData(filterForm);
            
            for (const [key, value] of formData.entries()) {
                if (value !== 'all') {
                    newUrl.searchParams.set(key, value);
                }
            }
            
            window.location.href = newUrl.toString();
        });

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-button')) {
                const idToDelete = e.target.dataset.id;
                
                if (confirm('Are you sure you want to delete this?')) {
                    fetch(`/api/transactions/${idToDelete}`, { method: 'DELETE' })
                    .then(function(response) {
                        if (response.ok) {
                            window.location.reload();
                        } else {
                            alert('Oops! Could not delete that transaction.');
                        }
                    });
                }
            } else if (e.target.classList.contains('edit-button')) {
                const idToEdit = e.target.dataset.id;
                const transactionToEdit = allTransactions.find(function(item) {
                    return item.id == idToEdit;
                });
                
                if (transactionToEdit) {
                    titleText.textContent = 'Edit This Transaction';
                    submitBtnText.textContent = 'Update';
                    hiddenId.value = transactionToEdit.id;
                    addForm.date.value = transactionToEdit.date;
                    addForm.description.value = transactionToEdit.description;
                    addForm.category.value = transactionToEdit.category;
                    addForm.type.value = transactionToEdit.type;
                    addForm.amount.value = transactionToEdit.amount;
                    addModal.style.display = 'block';
                }
            }
        });
    </script>
</body>
</html>